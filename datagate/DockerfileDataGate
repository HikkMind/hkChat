FROM golang:alpine AS builder

WORKDIR /app

COPY ./shared/tables ./shared/tables
COPY ./datagate ./datagate
COPY ./shared/proto ./shared/proto

WORKDIR /app/datagate

RUN apk add --no-cache curl
RUN curl -L https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/v0.4.24/grpc_health_probe-linux-amd64 -o /bin/grpc_health_probe
RUN chmod +x /bin/grpc_health_probe

RUN go mod download
RUN go build -o datagate

FROM alpine:3
COPY --from=builder /app/datagate/datagate /bin/datagate
COPY --from=builder /app/datagate/.dbenv /bin/.dbenv
COPY --from=builder /bin/grpc_health_probe /bin/grpc_health_probe
EXPOSE 6002

WORKDIR /bin

ENTRYPOINT ["./datagate"]
