FROM golang:alpine AS builder

WORKDIR /app

# COPY ./go.mod ./go.sum ./
COPY ./auth ./auth
COPY ./.dbenv ./auth
COPY ./shared/tables ./shared/tables
COPY ./shared/proto ./shared/proto

WORKDIR /app/auth

RUN go mod download
RUN apk add --no-cache curl
# RUN apt get install -y curl
RUN curl -L https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/v0.4.24/grpc_health_probe-linux-amd64 -o /bin/grpc_health_probe
RUN chmod +x /bin/grpc_health_probe


RUN go build -o auth

FROM alpine:3
COPY --from=builder /app/auth/auth /bin/auth
COPY --from=builder /app/auth/.dbenv /bin/.dbenv
COPY --from=builder /bin/grpc_health_probe /bin/grpc_health_probe
EXPOSE 8081
EXPOSE 6001

WORKDIR /bin

ENTRYPOINT ["./auth"]
